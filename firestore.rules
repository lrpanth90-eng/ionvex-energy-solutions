rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ================= COMMON FUNCTIONS ================= */
    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isSignedIn() && userDoc().role == "ADMIN";
    }

    function isDealer() {
      return isSignedIn() && userDoc().role == "DEALER";
    }

    /* ================= USERS ================= */
    match /users/{uid} {

      // User apna data dekh sakta hai
      allow read: if isSignedIn() && request.auth.uid == uid;

      // User first time apna profile create kar sakta hai
      allow create: if isSignedIn() && request.auth.uid == uid;

      // Sirf admin kisi ka role change kare
      allow update: if isAdmin();

      allow delete: if false;
    }

    /* ================= DEALER REGISTRATION REQUEST ================= */
    match /dealerRequests/{requestId} {

      // Dealer request submit kare
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.status == "PENDING";

      // Dealer apni request dekh sake
      allow read: if isSignedIn()
        && resource.data.uid == request.auth.uid;

      // Admin sab dekh sakta hai
      allow read: if isAdmin();

      // Admin approve / reject kare
      allow update: if isAdmin();

      allow delete: if isAdmin();
    }

    /* ================= BATTERIES / SERIALS ================= */
    match /batteries/{serial} {

      // üåç Public warranty check
      allow read: if true;

      // üè≠ Admin bulk upload / edit / delete
      allow create, update, delete: if isAdmin();

      // üîß Dealer warranty activate kare (sirf ek baar)
      allow update: if isDealer()
        && resource.data.status != "ACTIVE"
        && request.resource.data.status == "ACTIVE"
        && request.resource.data.activatedBy == request.auth.uid
        && request.resource.data.activationDate is timestamp;
    }

    /* ================= WARRANTY CLAIMS ================= */
    match /warrantyClaims/{claimId} {

      // Dealer claim submit kare
      allow create: if isDealer()
        && request.resource.data.dealerId == request.auth.uid
        && request.resource.data.status == "SUBMITTED";

      // Dealer apne claims dekhe
      allow read: if isDealer()
        && resource.data.dealerId == request.auth.uid;

      // Admin sab claims dekhe
      allow read: if isAdmin();

      // Admin approve / reject / update kare
      allow update: if isAdmin();

      allow delete: if false;
    }

    /* ================= PRODUCTS ================= */
    match /products/{productId} {

      // Public products dekh sake
      allow read: if true;

      // Admin product manage kare
      allow create, update, delete: if isAdmin();
    }

    /* ================= AUDIT LOGS ================= */
    match /logs/{logId} {

      // Sirf admin logs dekh sake
      allow read: if isAdmin();

      // System / admin logs likhe
      allow create: if isAdmin();

      allow update, delete: if false;
    }
  }
}
